{% extends "base.html" %}

{% block title %}Agendamiento de Horario{% endblock %}

{% block content %}
    
    <div class="container margin_top">
        <h1 class="text-center">Agendamiento de Horario</h1>

        <form method="POST" action="{{ url_for('manage_schedule') }}" class="my-4">
            <input type="hidden" name="action" value="add">
            <div class="form-group">
                <label for="lab_id">Laboratorio</label>
                <select class="form-control" id="lab_id" name="lab_id" required>
                    {% if labs %}
                        {% for lab in labs %}
                        <option value="{{ lab.id }}">{{ lab.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled selected>No hay laboratorios disponibles</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label for="profe_search">Profesor (Buscar por Identificación o Nombre)</label>
                <input type="text" class="form-control" id="profe_search" placeholder="Buscar profesor..." oninput="filterProfes()">
                <input type="hidden" id="profe_id" name="profe_id" required>
                <ul class="list-group mt-2" id="profe_list" style="max-height: 200px; overflow-y: auto;">
                    {% if users|length > 0 and users|selectattr('role', 'equalto', 'profe')|list|length > 0 %}
                        {% for user in users %}
                        {% if user.role == 'profe' %}
                        <li class="list-group-item" data-id="{{ user.id }}" data-name="{{ user.name }}" data-qr="{{ user.qr_code }}" onclick="selectProfe(this)">
                            {{ user.qr_code }} - {{ user.name }}
                        </li>
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item text-muted">No hay profesores disponibles</li>
                    {% endif %}
                </ul>
            </div>
            <div class="form-group">
                <label for="schedule_type">Tipo de Agendamiento:</label>
                <select class="form-control" id="schedule_type" name="schedule_type" required>
                    <option value="day">Por Día</option>
                    <option value="date">Por Fecha</option>
                </select>
            </div>
            <div class="form-group" id="day_of_week_container" style="display: none;">
                <label for="day_of_week">Día de la Semana:</label>
                <select class="form-control" id="day_of_week" name="day_of_week">
                    <option value="lunes">Lunes</option>
                    <option value="martes">Martes</option>
                    <option value="miércoles">Miércoles</option>
                    <option value="jueves">Jueves</option>
                    <option value="viernes">Viernes</option>
                    <option value="sábado">Sábado</option>
                </select>
            </div>
            <div class="mb-3" id="date_container" style="display: none;">
                <label for="date" class="form-label">Fecha:</label>
                <input type="date" class="form-control" id="date" name="date">
            </div>
            <div class="form-group">
                <label for="start_time">Hora de Inicio</label>
                <input type="time" class="form-control" id="start_time" name="start_time" step="60" required>
            </div>
            <div class="form-group">
                <label for="end_time">Hora de Fin</label>
                <input type="time" class="form-control" id="end_time" name="end_time" step="" required>
            </div>
            <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
        <h2>Horarios</h2>
        <table id="dataTable_horario" class="table table-striped">
            <thead>
                <tr>
                    <th class="centered">ID</th>
                    <th class="centered">Laboratorio</th>
                    <th class="centered">Profesor</th>
                    <th class="centered">Tipo</th>
                    <th class="centered">Día/Fecha</th>
                    <th class="centered">Hora de Inicio</th>
                    <th class="centered">Hora de Fin</th>
                    <th class="centered">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in schedules %}
                <tr>
                    <td>{{ schedule.id }}</td>
                    <td>{{ schedule.lab.name }}</td>
                    <td>{{ schedule.assigned_user.name }}</td>
                    <td>{{ schedule.schedule_type }}</td>
                    <td>
                        {% if schedule.schedule_type == 'day' %}
                        {{ schedule.day_of_week }}
                        {% elif schedule.schedule_type == 'date' %}
                        {{ schedule.date }}
                        {% endif %}
                    </td>
                    <td>{{ schedule.start_time }}</td>
                    <td>{{ schedule.end_time }}</td>
                    <td>
                        <form method="POST" style="display:inline; margin:0; padding:0; border:none;">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                            <button type="submit" class="btn btn-danger btn-sm" style="margin:0; padding:5px 10px; border:none;">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </form>
                        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editModal{{ schedule.id }}" style="margin:0; padding:5px 10px;">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

   <!-- Edit Modal -->
   {% for schedule in schedules %}
   <div class="modal fade" id="editModal{{ schedule.id }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel{{ schedule.id }}" aria-hidden="true">
       <div class="modal-dialog" role="document">
           <div class="modal-content">
               <div class="modal-header">
                   <h5 class="modal-title h3" id="editModalLabel{{ schedule.id }}">Editar Horario</h5>
                   <button type="button" class="close custom-close" data-dismiss="modal" aria-label="Close">
                       <span aria-hidden="true">&times;</span>
                   </button>
               </div>
               <form  method="POST" action="{{ url_for('manage_schedule') }}">
                   <div class="modal-body">
                       <input type="hidden" name="action" value="edit">
                       <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                       <div class="form-group">
                           <label for="lab_id{{ schedule.id }}">Laboratorio</label>
                           <select class="form-control" id="lab_id{{ schedule.id }}" name="lab_id" required>
                               {% for lab in labs %}
                               <option value="{{ lab.id }}" {% if lab.id == schedule.lab_id %}selected{% endif %}>{{ lab.name }}</option>
                               {% endfor %}
                           </select>
                       </div>
                       <div class="form-group">
                           <label for="profe_search_edit{{ schedule.id }}">Profesor (Buscar por Identificación o Nombre)</label>
                           <input type="text" class="form-control" id="profe_search_edit{{ schedule.id }}" placeholder="Buscar profesor..." value="{{ schedule.assigned_user.name }}" autocomplete="off">
                           <input type="hidden" id="profe_id_edit{{ schedule.id }}" name="profe_id" value="{{ schedule.profe_id }}" required>
                           <ul class="list-group mt-2" id="profe_list_edit{{ schedule.id }}" style="max-height: 200px; overflow-y: auto; display: none; position: absolute; width: 100%; z-index: 1050;">
                               {% for user in users %}
                                   {% if user.role == 'profe' %}
                                   <li class="list-group-item{% if user.id == schedule.profe_id %} active{% endif %}"
                                       data-id="{{ user.id }}"
                                       data-name="{{ user.name }}"
                                       data-qr="{{ user.qr_code }}">
                                       {{ user.qr_code }} - {{ user.name }}
                                   </li>
                                   {% endif %}
                               {% endfor %}
                               {% if users|selectattr('role', 'equalto', 'profe')|list|length == 0 %}
                                   <li class="list-group-item text-muted">No hay profesores disponibles</li>
                               {% endif %}
                           </ul>
                       </div>
                       <div class="form-group">
                           <label for="schedule_type{{ schedule.id }}">Tipo de Agendamiento:</label>
                           <select class="form-control" id="schedule_type{{ schedule.id }}" name="schedule_type" required>
                               <option value="day" {% if schedule.schedule_type == 'day' %}selected{% endif %}>Por Día</option>
                               <option value="date" {% if schedule.schedule_type == 'date' %}selected{% endif %}>Por Fecha</option>
                           </select>
                       </div>
                       <div class="form-group" id="day_of_week_container{{ schedule.id }}" style="display: {% if schedule.schedule_type == 'day' %}block{% else %}none{% endif %};">
                           <label for="day_of_week{{ schedule.id }}">Día de la Semana:</label>
                           <select class="form-control" id="day_of_week{{ schedule.id }}" name="day_of_week">
                               <option value="lunes" {% if schedule.day_of_week == 'lunes' %}selected{% endif %}>Lunes</option>
                               <option value="martes" {% if schedule.day_of_week == 'martes' %}selected{% endif %}>Martes</option>
                               <option value="miércoles" {% if schedule.day_of_week == 'miércoles' %}selected{% endif %}>Miércoles</option>
                               <option value="jueves" {% if schedule.day_of_week == 'jueves' %}selected{% endif %}>Jueves</option>
                               <option value="viernes" {% if schedule.day_of_week == 'viernes' %}selected{% endif %}>Viernes</option>
                               <option value="sábado" {% if schedule.day_of_week == 'sábado' %}selected{% endif %}>Sábado</option>
                           </select>
                       </div>
                       <div class="mb-3" id="date_container{{ schedule.id }}" style="display: {% if schedule.schedule_type == 'date' %}block{% else %}none{% endif %};">
                           <label for="date{{ schedule.id }}" class="form-label">Fecha:</label>
                           <input type="date" class="form-control" id="date{{ schedule.id }}" name="date" value="{{ schedule.date }}">
                       </div>
                       <div class="form-group">
                           <label for="start_time{{ schedule.id }}">Hora de Inicio</label>
                           <input type="time" class="form-control" id="start_time{{ schedule.id }}" name="start_time" value="{{ schedule.start_time }}" required>
                       </div>
                       <div class="form-group">
                           <label for="end_time{{ schedule.id }}">Hora de Fin</label>
                           <input type="time" class="form-control" id="end_time{{ schedule.id }}" name="end_time" value="{{ schedule.end_time }}" required>
                       </div>
                   </div>
                   <div class="modal-footer">
                       <button type="button" class="btn btn-secondary close" data-dismiss="modal">Cerrar</button>
                       <button type="submit" class="btn btn-primary">Guardar cambios</button>
                   </div>
               </form>
           </div>
       </div>
   </div>
   {% endfor %}
</div>

<script>
    const scheduleType = document.getElementById('schedule_type');
    const dayOfWeekContainer = document.getElementById('day_of_week_container');
    const dateContainer = document.getElementById('date_container');
    const profeSearch = document.getElementById('profe_search');
    const profeList = document.getElementById('profe_list');

    // Mostrar el contenedor correcto al cargar la página
    function updateScheduleType() {
        if (scheduleType.value === 'day') {
            dayOfWeekContainer.style.display = 'block';
            dateContainer.style.display = 'none';
        } else if (scheduleType.value === 'date') {
            dayOfWeekContainer.style.display = 'none';
            dateContainer.style.display = 'block';
        } else {
            dayOfWeekContainer.style.display = 'none';
            dateContainer.style.display = 'none';
        }
    }

    scheduleType.addEventListener('change', updateScheduleType);

    // Llamar a la función al cargar la página para establecer el estado inicial
    document.addEventListener('DOMContentLoaded', updateScheduleType);

    function filterProfes() {
        const searchValue = profeSearch.value.toLowerCase();
        const profeItems = profeList.getElementsByTagName('li');
        let hasVisibleItems = false;

        for (let profe of profeItems) {
            if (profe.classList.contains('text-muted')) continue; // Ignorar mensajes estáticos como "No hay profesores disponibles"
            const name = profe.getAttribute('data-name').toLowerCase();
            const qr = profe.getAttribute('data-qr').toLowerCase();
            if (name.includes(searchValue) || qr.includes(searchValue)) {
                profe.style.display = '';
                hasVisibleItems = true;
            } else {
                profe.style.display = 'none';
            }
        }

        // Mostrar el mensaje "No hay coincidencias" solo si no hay elementos visibles y el campo de búsqueda no está vacío
        const noResultsItem = profeList.querySelector('.no-results');
        if (!hasVisibleItems && searchValue.trim() !== '') {
            if (!noResultsItem) {
                const newNoResultsItem = document.createElement('li');
                newNoResultsItem.className = 'list-group-item text-muted no-results';
                newNoResultsItem.textContent = 'No hay coincidencias';
                profeList.appendChild(newNoResultsItem);
            }
        } else if (noResultsItem) {
            noResultsItem.remove();
        }

        // Mostrar la lista si hay elementos visibles o si el mensaje "No hay coincidencias" está presente
        profeList.style.display = hasVisibleItems || noResultsItem ? 'block' : 'none';
    }

    function selectProfe(profeElement) {
        const profeId = profeElement.getAttribute('data-id');
        const profeName = profeElement.getAttribute('data-name');
        profeSearch.value = `${profeName}`;
        document.getElementById('profe_id').value = profeId;
        profeList.style.display = 'none';
    }

    // Mostrar la lista solo cuando el usuario comience a escribir
    profeSearch.addEventListener('input', function () {
        if (this.value.trim() !== '') {
            filterProfes();
        } else {
            profeList.style.display = 'none';
        }
    });

    // Ocultar la lista si se hace clic fuera del campo de búsqueda o la lista
    document.addEventListener('click', function (event) {
        if (!profeSearch.contains(event.target) && !profeList.contains(event.target)) {
            profeList.style.display = 'none';
        }
    });

    // Funciones para el buscador de profesores en el modal de edición
    function filterProfesEdit(scheduleId) {
        const input = document.getElementById('profe_search_edit' + scheduleId);
        const list = document.getElementById('profe_list_edit' + scheduleId);
        const value = input.value.trim().toLowerCase();
        let found = false;

        // Elimina mensaje de "no coincidencias" si existe
        let noResults = list.querySelector('.no-results');
        if (noResults) noResults.remove();

        // Si el input está vacío, muestra solo el profesor agendado
        if (value === '') {
            let anyActive = false;
            list.querySelectorAll('li[data-id]').forEach(li => {
                if (li.classList.contains('active')) {
                    li.style.display = '';
                    anyActive = true;
                } else {
                    li.style.display = 'none';
                }
            });
            list.style.display = anyActive ? 'block' : 'none';
            return;
        }

        // Si hay texto, filtra normalmente
        list.querySelectorAll('li[data-id]').forEach(li => {
            const name = li.getAttribute('data-name').toLowerCase();
            const qr = li.getAttribute('data-qr').toLowerCase();
            if (name.includes(value) || qr.includes(value)) {
                li.style.display = '';
                found = true;
            } else {
                li.style.display = 'none';
            }
        });

        // Si no hay coincidencias, muestra mensaje
        if (!found) {
            const msg = document.createElement('li');
            msg.className = 'list-group-item text-muted no-results';
            msg.textContent = 'No hay coincidencias';
            list.appendChild(msg);
        }
        list.style.display = 'block';
    }

    function selectProfeEdit(li, scheduleId) {
        const input = document.getElementById('profe_search_edit' + scheduleId);
        const hidden = document.getElementById('profe_id_edit' + scheduleId);
        const list = document.getElementById('profe_list_edit' + scheduleId);
        input.value = li.getAttribute('data-name');
        hidden.value = li.getAttribute('data-id');
        list.style.display = 'none';
        // Quitar clase active de todos y poner solo al seleccionado
        list.querySelectorAll('li[data-id]').forEach(el => el.classList.remove('active'));
        li.classList.add('active');
    }

    function showProfeListEdit(scheduleId) {
        const list = document.getElementById('profe_list_edit' + scheduleId);
        filterProfesEdit(scheduleId);
        list.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function () {
        {% for schedule in schedules %}
        (function(scheduleId){
            const input = document.getElementById('profe_search_edit' + scheduleId);
            const list = document.getElementById('profe_list_edit' + scheduleId);
            if (input) {
                input.addEventListener('input', function () {
                    filterProfesEdit(scheduleId);
                });
                input.addEventListener('focus', function () {
                    filterProfesEdit(scheduleId);
                    list.style.display = 'block';
                });
            }
            // Delegar el click en la lista para seleccionar profesor
            if (list) {
                list.addEventListener('click', function (event) {
                    const li = event.target.closest('li[data-id]');
                    if (li) {
                        selectProfeEdit(li, scheduleId);
                    }
                });
            }
            // Ocultar la lista si se hace clic fuera
            document.addEventListener('mousedown', function (event) {
                if (input && list && !input.contains(event.target) && !list.contains(event.target)) {
                    list.style.display = 'none';
                }
            });
            // Al abrir el modal, muestra solo el profesor agendado
            $('#editModal' + scheduleId).on('shown.bs.modal', function () {
                filterProfesEdit(scheduleId);
            });
        })({{ schedule.id }});
        {% endfor %}
    });

    // Función para mostrar/ocultar campos en el modal de edición según el tipo de agendamiento
    function updateScheduleTypeEdit(scheduleId) {
        const typeSelect = document.getElementById('schedule_type' + scheduleId);
        const dayContainer = document.getElementById('day_of_week_container' + scheduleId);
        const dateContainer = document.getElementById('date_container' + scheduleId);
        if (!typeSelect || !dayContainer || !dateContainer) return;
        if (typeSelect.value === 'day') {
            dayContainer.style.display = 'block';
            dateContainer.style.display = 'none';
        } else if (typeSelect.value === 'date') {
            dayContainer.style.display = 'none';
            dateContainer.style.display = 'block';
        } else {
            dayContainer.style.display = 'none';
            dateContainer.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        {% for schedule in schedules %}
        // Manejar el cambio de tipo de agendamiento en el modal de edición
        var typeSelect = document.getElementById('schedule_type{{ schedule.id }}');
        if (typeSelect) {
            typeSelect.addEventListener('change', function () {
                updateScheduleTypeEdit({{ schedule.id }});
            });
            // Inicializar el estado correcto al abrir el modal
            $('#editModal{{ schedule.id }}').on('shown.bs.modal', function () {
                updateScheduleTypeEdit({{ schedule.id }});
            });
        }
        {% endfor %}
    });
</script>

<style>
    #profe_list {
        display: none;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        position: absolute;
        z-index: 1000;
        width: 100%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #profe_list .list-group-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    #profe_list .list-group-item:hover {
        background-color: #f1f1f1;
    }

    #profe_search:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
</style>
{% endblock %}